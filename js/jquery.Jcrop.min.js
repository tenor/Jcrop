(function(p){p.Jcrop=function(I,S){function t(a){return parseInt(a,10)+"px"}function H(a){return parseInt(a,10)+"%"}function T(a){a=p(a).offset();return[a.left,a.top]}function N(a){return[a.pageX-Z[0],a.pageY-Z[1]]}function da(a){if(typeof a!=="object")a={};b=p.extend(b,a);if(typeof b.onChange!=="function")b.onChange=function(){};if(typeof b.onSelect!=="function")b.onSelect=function(){};if(typeof b.onRelease!=="function")b.onRelease=function(){}}function O(a,f){Z=T(r);J.setCursor(a==="move"?a:a+"-resize");
if(a==="move")return J.activateHandlers(ha(f),ia);var g=u.getFixed(),n=oa(a),d=u.getCorner(oa(n));u.setPressed(u.getCorner(n));u.setCurrent(d);J.activateHandlers(ea(a,g),ia)}function ea(a,f){return function(g){if(b.aspectRatio)switch(a){case "e":g[1]=f.y+1;break;case "w":g[1]=f.y+1;break;case "n":g[0]=f.x+1;break;case "s":g[0]=f.x+1}else switch(a){case "e":g[1]=f.y2;break;case "w":g[1]=f.y2;break;case "n":g[0]=f.x2;break;case "s":g[0]=f.x2}u.setCurrent(g);s.update()}}function ha(a){var f=a;ja.watchKeys();
return function(g){u.moveOffset([g[0]-f[0],g[1]-f[1]]);f=g;s.update()}}function oa(a){switch(a){case "n":return"sw";case "s":return"nw";case "e":return"nw";case "w":return"ne";case "ne":return"sw";case "nw":return"se";case "se":return"nw";case "sw":return"ne"}}function pa(a){return function(f){if(b.disabled)return false;if(a==="move"&&!b.allowMove)return false;U=true;O(a,N(f));f.stopPropagation();f.preventDefault();return false}}function qa(a,f,g){var n=a.width(),d=a.height();if(n>f&&f>0){n=f;d=f/
a.width()*a.height()}if(d>g&&g>0){d=g;n=g/a.height()*a.width()}C=a.width()/n;E=a.height()/d;a.width(n).height(d)}function ka(a){return{x:parseInt(a.x*C,10),y:parseInt(a.y*E,10),x2:parseInt(a.x2*C,10),y2:parseInt(a.y2*E,10),w:parseInt(a.w*C,10),h:parseInt(a.h*E,10)}}function ia(){var a=u.getFixed();if(a.w>b.minSelect[0]&&a.h>b.minSelect[1]){s.enableHandles();s.done()}else s.release();J.setCursor(b.allowSelect?"crosshair":"default")}function ra(a){if(b.disabled)return false;if(!b.allowSelect)return false;
U=true;Z=T(r);s.disableHandles();if("crosshair"!==sa){J.setCursor("crosshair");sa="crosshair"}var f=N(a);u.setPressed(f);s.update();J.activateHandlers(za,ia);ja.watchKeys();a.stopPropagation();a.preventDefault();return false}function za(a){u.setCurrent(a);s.update()}function ta(){var a=p("<div></div>").addClass(b.baseClass+"-tracker");p.browser.msie&&a.css({opacity:0,backgroundColor:"white"});return a}function ua(a){va([parseInt(a[0],10)/C,parseInt(a[1],10)/E,parseInt(a[2],10)/C,parseInt(a[3],10)/
E])}function va(a){u.setPressed([a[0],a[1]]);u.setCurrent([a[2],a[3]]);s.update()}function wa(){b.disabled=true;s.disableHandles();s.setCursor("default");J.setCursor("default")}function xa(){b.disabled=false;la()}function la(a){if(b.allowResize)a?s.enableOnly():s.enableHandles();else s.disableHandles();J.setCursor(b.allowSelect?"crosshair":"default");s.setCursor(b.allowMove?"move":"default");if(b.hasOwnProperty("setSelect")){ua(b.setSelect);s.done();delete b.setSelect}if(b.hasOwnProperty("trueSize")){C=
b.trueSize[0]/z;E=b.trueSize[1]/v}if(b.hasOwnProperty("bgColor")){p.fx.step.hasOwnProperty("backgroundColor")&&b.fadeTime?F.animate({backgroundColor:b.bgColor},{queue:false,duration:b.fadeTime}):F.css("backgroundColor",b.bgColor);delete b.bgColor}if(b.hasOwnProperty("bgOpacity")){fa=b.bgOpacity;if(s.isAwake())b.fadeTime?r.fadeTo(b.fadeTime,fa):F.css("opacity",b.opacity);delete b.bgOpacity}$=b.maxSize[0]||0;aa=b.maxSize[1]||0;ba=b.minSize[0]||0;ca=b.minSize[1]||0;if(b.hasOwnProperty("outerImage")){r.attr("src",
b.outerImage);delete b.outerImage}s.refresh()}var b=p.extend({},p.Jcrop.defaults),Z,sa,ma=false;if(p.browser.msie&&p.browser.version.split(".")[0]==="6")ma=true;if(typeof I!=="object")I=p(I)[0];if(typeof S!=="object")S={};da(S);var ya={border:"none",margin:0,padding:0,position:"absolute"},K=p(I),r=K.clone().removeAttr("id").css(ya);r.width(K.width());r.height(K.height());var Aa=K.offset().left,Ba=K.offset().top;K.after(r).hide();qa(r,b.boxWidth,b.boxHeight);var z=r.width(),v=r.height(),F=p("<div />").width(z).height(v).addClass(b.baseClass+
"-holder").css({position:"relative",backgroundColor:b.bgColor}).insertAfter(K).append(r);delete b.bgColor;b.addClass&&F.addClass(b.addClass);var ga=p("<img />").attr("src",r.attr("src")).css(ya).width(z).height(v),na=p("<div />").width(H(100)).height(H(100)).css({zIndex:310,position:"absolute",overflow:"hidden"}).append(ga),V=p("<div />").width(H(100)).height(H(100)).css("zIndex",320),W=p("<div />").css({position:"absolute",zIndex:300}).insertBefore(r).append(na,V);ma&&W.css({overflowY:"hidden"});
var X=b.boundary,P=ta().width(z+X*2).height(v+X*2).css({position:"absolute",top:t(-X),left:t(-X),zIndex:290}).mousedown(ra),fa=b.bgOpacity,$,aa,ba,ca,C,E,U,Ca;Z=T(r);var Q=function(){function a(){var f={},g=["touchstart","touchmove","touchend"],n=document.createElement("div"),d;try{for(d=0;d<g.length;d++){var e=g[d];e="on"+e;var j=e in n;if(!j){n.setAttribute(e,"return;");j=typeof n[e]=="function"}f[g[d]]=j}return f.touchstart&&f.touchend&&f.touchmove}catch(i){return false}}return{createDragger:function(f){return function(g){g.pageX=
g.originalEvent.changedTouches[0].pageX;g.pageY=g.originalEvent.changedTouches[0].pageY;if(b.disabled)return false;if(f==="move"&&!b.allowMove)return false;U=true;O(f,N(g));g.stopPropagation();g.preventDefault();return false}},newSelection:function(f){f.pageX=f.originalEvent.changedTouches[0].pageX;f.pageY=f.originalEvent.changedTouches[0].pageY;return ra(f)},isSupported:a,support:b.touchSupport===true||b.touchSupport===false?b.touchSupport:a()}}(),u=function(){function a(){if(!b.aspectRatio){var c=
j-d,m=i-e;if($&&Math.abs(c)>$)j=c>0?d+$:d-$;if(aa&&Math.abs(m)>aa)i=m>0?e+aa:e-aa;if(ca/E&&Math.abs(m)<ca/E)i=m>0?e+ca/E:e-ca/E;if(ba/C&&Math.abs(c)<ba/C)j=c>0?d+ba/C:d-ba/C;if(d<0){j-=d;d-=d}if(e<0){i-=e;e-=e}if(j<0){d-=j;j-=j}if(i<0){e-=i;i-=i}if(j>z){c=j-z;d-=c;j-=c}if(i>v){c=i-v;e-=c;i-=c}if(d>z){c=d-v;i-=c;e-=c}if(e>v){c=e-v;i-=c;e-=c}return n(g(d,e,j,i))}c=b.aspectRatio;m=b.minSize[0]/C;var A=b.maxSize[0]/C,q=j-d,D=i-e,o=Math.abs(q),l=Math.abs(D),k=o/l;if(A===0)A=z*10;if(k<c){o=i;w=l*c;l=q<
0?d-w:w+d;if(l<0){l=0;h=Math.abs((l-d)/c);o=D<0?e-h:h+e}else if(l>z){l=z;h=Math.abs((l-d)/c);o=D<0?e-h:h+e}}else{l=j;h=o/c;o=D<0?e-h:e+h;if(o<0){o=0;w=Math.abs((o-e)*c);l=q<0?d-w:w+d}else if(o>v){o=v;w=Math.abs(o-e)*c;l=q<0?d-w:w+d}}if(l>d){if(l-d<m)l=d+m;else if(l-d>A)l=d+A;o=o>e?e+(l-d)/c:e-(l-d)/c}else if(l<d){if(d-l<m)l=d-m;else if(d-l>A)l=d-A;o=o>e?e+(d-l)/c:e-(d-l)/c}if(l<0){d-=l;l=0}else if(l>z){d-=l-z;l=z}if(o<0){e-=o;o=0}else if(o>v){e-=o-v;o=v}return n(g(d,e,l,o))}function f(c){if(c[0]<
0)c[0]=0;if(c[1]<0)c[1]=0;if(c[0]>z)c[0]=z;if(c[1]>v)c[1]=v;return[c[0],c[1]]}function g(c,m,A,q){var D=c,o=A,l=m,k=q;if(A<c){D=A;o=c}if(q<m){l=q;k=m}return[Math.round(D),Math.round(l),Math.round(o),Math.round(k)]}function n(c){return{x:c[0],y:c[1],x2:c[2],y2:c[3],w:c[2]-c[0],h:c[3]-c[1]}}var d=0,e=0,j=0,i=0,L,M;return{flipCoords:g,setPressed:function(c){c=f(c);j=d=c[0];i=e=c[1]},setCurrent:function(c){c=f(c);L=c[0]-j;M=c[1]-i;j=c[0];i=c[1]},getOffset:function(){return[L,M]},moveOffset:function(c){var m=
c[0];c=c[1];if(0>d+m)m-=m+d;if(0>e+c)c-=c+e;if(v<i+c)c+=v-(i+c);if(z<j+m)m+=z-(j+m);d+=m;j+=m;e+=c;i+=c},getCorner:function(c){var m=a();switch(c){case "ne":return[m.x2,m.y];case "nw":return[m.x,m.y];case "se":return[m.x2,m.y2];case "sw":return[m.x,m.y2]}},getFixed:a}}(),s=function(){function a(k){k=p("<div />").css({position:"absolute",opacity:b.borderOpacity}).addClass(b.baseClass+"-"+k);na.append(k);return k}function f(k,B){var G=p("<div />").mousedown(pa(k)).css({cursor:k+"-resize",position:"absolute",
zIndex:B});Q.support&&G.bind("touchstart",Q.createDragger(k));V.append(G);return G}function g(k){var B=b.handleSize,G=B;B=B;var Y=o,Da=o;switch(k){case "n":case "s":B=H(100);break;case "e":case "w":G=H(100)}return f(k,A++).width(B).height(G).css({top:t(-Y+1),left:t(-Da+1)})}function n(k){var B;for(B=0;B<k.length;B++)q[k[B]]=f(k[B],A++).css({top:t(-o+1),left:t(-o+1),opacity:b.handleOpacity}).addClass(b.baseClass+"-handle")}function d(k){var B=Math.round(k.h/2-o),G=Math.round(k.w/2-o),Y=k.w-o;k=k.h-
o;if(q.e){q.e.css({top:t(B),left:t(Y)});q.w.css({top:t(B)});q.s.css({top:t(k),left:t(G)});q.n.css({left:t(G)})}if(q.ne){q.ne.css({left:t(Y)});q.se.css({top:t(k),left:t(Y)});q.sw.css({top:t(k)})}if(q.b){q.b.css({top:t(k)});q.r.css({left:t(Y)})}}function e(){var k=u.getFixed();u.setPressed([k.x,k.y]);u.setCurrent([k.x2,k.y2]);j()}function j(){if(m)return i()}function i(){var k=u.getFixed(),B=k.h;W.width(k.w).height(B);B=k.x;var G=k.y;ga.css({top:t(-G),left:t(-B)});W.css({top:t(G+(Ba-F.offset().top)),
left:t(B+(Aa-F.offset().left))});D&&d(k);if(!m){W.show();b.bgFade?r.fadeTo(b.fadeTime,fa):r.css("opacity",fa);m=true}b.onChange.call(R,ka(k))}function L(){D=true;if(b.allowResize){d(u.getFixed());V.show();return true}}function M(){D=false;V.hide()}function c(k){void 0===k?M():L()}var m,A=370,q={},D=false,o=b.handleOffset;if(b.drawBorders){a("hline");a("hline bottom");a("vline");a("vline right")}if(b.dragEdges){q.t=g("n");q.b=g("s");q.r=g("e");q.l=g("w")}b.sideHandles&&n(["n","s","e","w"]);b.cornerHandles&&
n(["sw","nw","ne","se"]);var l=ta().mousedown(pa("move")).css({cursor:"move",position:"absolute",zIndex:360});Q.support&&l.bind("touchstart.jcrop",Q.createDragger("move"));na.append(l);M();return{updateVisible:j,update:i,release:function(){M();W.hide();b.bgFade?r.fadeTo(b.fadeTime,1):r.css("opacity",1);m=false;b.onRelease.call(R)},refresh:e,isAwake:function(){return m},setCursor:function(k){l.css("cursor",k)},enableHandles:L,enableOnly:function(){D=true},showHandles:function(){if(D){d(u.getFixed());
V.show()}},disableHandles:M,animMode:c,done:function(){c(false);e()}}}(),J=function(){function a(i){d(N(i));return false}function f(i){i.preventDefault();i.stopPropagation();if(U){U=false;e(N(i));s.isAwake()&&b.onSelect.call(R,ka(u.getFixed()));P.css({zIndex:290});j&&p(document).unbind("mousemove",a).unbind("mouseup",f);d=function(){};e=function(){}}return false}function g(i){i.pageX=i.originalEvent.changedTouches[0].pageX;i.pageY=i.originalEvent.changedTouches[0].pageY;return a(i)}function n(i){i.pageX=
i.originalEvent.changedTouches[0].pageX;i.pageY=i.originalEvent.changedTouches[0].pageY;return f(i)}var d=function(){},e=function(){},j=b.trackDocument;Q.support&&p(document).bind("touchmove",g).bind("touchend",n);j||P.mousemove(a).mouseup(f).mouseout(f);r.before(P);return{activateHandlers:function(i,L){U=true;d=i;e=L;P.css({zIndex:450});j&&p(document).bind("mousemove",a).bind("mouseup",f);return false},setCursor:function(i){P.css("cursor",i)}}}(),ja=function(){function a(){n.hide()}function f(e,
j,i){if(b.allowMove){u.moveOffset([j,i]);s.updateVisible()}e.preventDefault();e.stopPropagation()}function g(e){if(e.ctrlKey)return true;var j=(Ca=e.shiftKey?true:false)?10:1;switch(e.keyCode){case 37:f(e,-j,0);break;case 39:f(e,j,0);break;case 38:f(e,0,-j);break;case 40:f(e,0,j);break;case 27:s.release();break;case 9:return true}return false}var n=p('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}),d=p("<div />").css({position:"absolute",overflow:"hidden"}).append(n);if(b.keySupport){n.keydown(g).blur(a);
if(ma||!b.fixedSupport){n.css({position:"absolute",left:"-20px"});d.append(n).insertBefore(r)}else n.insertBefore(r)}return{watchKeys:function(){if(b.keySupport){n.show();n.focus()}}}}();Q.support&&P.bind("touchstart",Q.newSelection);V.hide();la(true);var R={setImage:function(a,f){s.release();wa();var g=new Image;g.onload=function(){var n=g.height,d=b.boxWidth,e=b.boxHeight;r.width(g.width).height(n);r.attr("src",a);ga.attr("src",a);qa(r,d,e);z=r.width();v=r.height();ga.width(z).height(v);P.width(z+
X*2).height(v+X*2);F.width(z).height(v);xa();typeof f==="function"&&f.call(R)};g.src=a},animateTo:function(a,f){var g=parseInt(a[0],10)/C,n=parseInt(a[1],10)/E,d=parseInt(a[2],10)/C,e=parseInt(a[3],10)/E;g=u.flipCoords(g,n,d,e);n=u.getFixed();var j=[n.x,n.y,n.x2,n.y2],i=b.animationDelay,L=g[0]-j[0],M=g[1]-j[1],c=g[2]-j[2],m=g[3]-j[3],A=0,q=b.swingSpeed;x=j[0];y=j[1];d=j[2];e=j[3];s.animMode(true);var D=function(){return function(){A+=(100-A)/q;j[0]=x+A/100*L;j[1]=y+A/100*M;j[2]=d+A/100*c;j[3]=e+A/
100*m;if(A>=99.8)A=100;if(A<100){va(j);window.setTimeout(D,i)}else{s.done();typeof f==="function"&&f.call(R)}}}();window.setTimeout(D,i)},setSelect:ua,setOptions:function(a){da(a);la()},tellSelect:function(){return ka(u.getFixed())},tellScaled:function(){return u.getFixed()},setClass:function(a){F.removeClass().addClass(b.baseClass+"-holder").addClass(a)},disable:wa,enable:xa,cancel:function(){s.done();J.activateHandlers(null,null)},release:s.release,destroy:function(){K.show();p(I).removeData("Jcrop");
F.empty();F.remove()},focus:ja.watchKeys,getBounds:function(){return[z*C,v*E]},getWidgetSize:function(){return[z,v]},getScaleFactor:function(){return[C,E]},ui:{holder:F,selection:W}};p.browser.msie&&F.bind("selectstart",function(){return false});K.data("Jcrop",R);return R};p.fn.Jcrop=function(I,S){function t(T){var N=typeof I==="object"?I:{},da=N.useImg||T.src,O=new Image;O.onload=function(){function ea(){if(!O.width||!O.height)window.setTimeout(ea,50);else{var ha=p.Jcrop(T,N);typeof S==="function"&&
S.call(ha)}}window.setTimeout(ea,50)};O.src=da}var H=null;this.each(function(){if(p(this).data("Jcrop"))if(I==="api"){if(H==null)H=p(this).data("Jcrop")}else p(this).data("Jcrop").setOptions(I);else t(this)});return H?H:this};p.Jcrop.defaults={allowSelect:true,allowMove:true,allowResize:true,trackDocument:true,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:0.6,bgFade:false,borderOpacity:0.4,handleOpacity:0.5,handleSize:9,handleOffset:5,aspectRatio:0,keySupport:true,cornerHandles:true,sideHandles:true,
drawBorders:true,dragEdges:true,fixedSupport:true,touchSupport:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onRelease:function(){}}})(jQuery);
