(function(e){e.Jcrop=function(v,I){function p(b){return parseInt(b,10)+"px"}function B(b){return parseInt(b,10)+"%"}function W(b){b=e(b).offset();return[b.left,b.top]}function O(b){return[b.pageX-P[0],b.pageY-P[1]]}function J(b){typeof b!=="object"&&(b={});a=e.extend(a,b);if(typeof a.onChange!=="function")a.onChange=function(){};if(typeof a.onSelect!=="function")a.onSelect=function(){};if(typeof a.onRelease!=="function")a.onRelease=function(){}}function E(b,a){P=W(i);C.setCursor(b==="move"?b:b+"-resize"); if(b==="move")return C.activateHandlers(na(a),X);var f=s.getFixed(),o=ca(b),c=s.getCorner(ca(o));s.setPressed(s.getCorner(o));s.setCurrent(c);C.activateHandlers(oa(b,f),X)}function oa(b,k){return function(f){if(a.aspectRatio)switch(b){case "e":f[1]=k.y+1;break;case "w":f[1]=k.y+1;break;case "n":f[0]=k.x+1;break;case "s":f[0]=k.x+1}else switch(b){case "e":f[1]=k.y2;break;case "w":f[1]=k.y2;break;case "n":f[0]=k.x2;break;case "s":f[0]=k.x2}s.setCurrent(f);m.update()}}function na(b){var a=b;Y.watchKeys(); return function(b){s.moveOffset([b[0]-a[0],b[1]-a[1]]);a=b;m.update()}}function ca(b){switch(b){case "n":return"sw";case "s":return"nw";case "e":return"nw";case "w":return"ne";case "ne":return"sw";case "nw":return"se";case "se":return"nw";case "sw":return"ne"}}function da(b){return function(k){if(a.disabled)return!1;if(b==="move"&&!a.allowMove)return!1;K=!0;E(b,O(k));k.stopPropagation();k.preventDefault();return!1}}function ea(b,a,f){var o=b.width(),c=b.height();o>a&&a>0&&(o=a,c=a/b.width()*b.height()); c>f&&f>0&&(c=f,o=f/b.height()*b.width());t=b.width()/o;A=b.height()/c;b.width(o).height(c)}function Z(a){return{x:parseInt(a.x*t,10),y:parseInt(a.y*A,10),x2:parseInt(a.x2*t,10),y2:parseInt(a.y2*A,10),w:parseInt(a.w*t,10),h:parseInt(a.h*A,10)}}function X(){var b=s.getFixed();b.w>a.minSelect[0]&&b.h>a.minSelect[1]?(m.enableHandles(),m.done()):m.release();C.setCursor(a.allowSelect?"crosshair":"default")}function fa(b){if(a.disabled)return!1;if(!a.allowSelect)return!1;K=!0;P=W(i);m.disableHandles();"crosshair"!== ga&&(C.setCursor("crosshair"),ga="crosshair");var k=O(b);s.setPressed(k);m.update();C.activateHandlers(pa,X);Y.watchKeys();b.stopPropagation();b.preventDefault();return!1}function pa(a){s.setCurrent(a);m.update()}function ha(){var b=e("<div></div>").addClass(a.baseClass+"-tracker");e.browser.msie&&b.css({opacity:0,backgroundColor:"white"});return b}function ia(a){ja([parseInt(a[0],10)/t,parseInt(a[1],10)/A,parseInt(a[2],10)/t,parseInt(a[3],10)/A])}function ja(a){s.setPressed([a[0],a[1]]);s.setCurrent([a[2], a[3]]);m.update()}function ka(){a.disabled=!0;m.disableHandles();m.setCursor("default");C.setCursor("default")}function la(){a.disabled=!1;$()}function $(b){a.allowResize?b?m.enableOnly():m.enableHandles():m.disableHandles();C.setCursor(a.allowSelect?"crosshair":"default");m.setCursor(a.allowMove?"move":"default");a.hasOwnProperty("setSelect")&&(ia(a.setSelect),m.done(),delete a.setSelect);a.hasOwnProperty("trueSize")&&(t=a.trueSize[0]/r,A=a.trueSize[1]/q);a.hasOwnProperty("bgColor")&&(e.fx.step.hasOwnProperty("backgroundColor")&& a.fadeTime?u.animate({backgroundColor:a.bgColor},{queue:!1,duration:a.fadeTime}):u.css("backgroundColor",a.bgColor),delete a.bgColor);if(a.hasOwnProperty("bgOpacity"))U=a.bgOpacity,m.isAwake()&&(a.fadeTime?i.fadeTo(a.fadeTime,U):u.css("opacity",a.opacity)),delete a.bgOpacity;Q=a.maxSize[0]||0;R=a.maxSize[1]||0;S=a.minSize[0]||0;T=a.minSize[1]||0;a.hasOwnProperty("outerImage")&&(i.attr("src",a.outerImage),delete a.outerImage);m.refresh()}var a=e.extend({},e.Jcrop.defaults),P,ga,aa=!1;e.browser.msie&& e.browser.version.split(".")[0]==="6"&&(aa=!0);typeof v!=="object"&&(v=e(v)[0]);typeof I!=="object"&&(I={});J(I);var ma={border:"none",margin:0,padding:0,position:"absolute"},D=e(v),i=D.clone().removeAttr("id").css(ma);i.width(D.width());i.height(D.height());var qa=D.offset().left,ra=D.offset().top;D.after(i).hide();ea(i,a.boxWidth,a.boxHeight);if(a.container===null)a.container=i;var r=i.width(),q=i.height(),u=e("<div />").width(e(a.container).width()).height(e(a.container).height()).addClass(a.baseClass+ "-holder").css({position:"relative",backgroundColor:a.bgColor}).insertAfter(D).append(i);delete a.bgColor;a.addClass&&u.addClass(a.addClass);var V=e("<img />").attr("src",i.attr("src")).css(ma).width(r).height(q),ba=e("<div />").width(B(100)).height(B(100)).css({zIndex:310,position:"absolute",overflow:"hidden"}).append(V),L=e("<div />").width(B(100)).height(B(100)).css("zIndex",320),M=e("<div />").css({position:"absolute",zIndex:300}).insertBefore(i).append(ba,L);aa&&M.css({overflowY:"hidden"});var N= a.boundary,F=ha().width(e(a.container).width()+N*2).height(e(a.container).height()+N*2).css({position:"absolute",top:p(-N+(a.container==i?i.position().top:0)),left:p(-N+(a.container==i?i.position().left:0)),zIndex:290}).mousedown(fa),U=a.bgOpacity,Q,R,S,T,t,A,K,sa;P=W(i);var G=function(){function b(){var a={},b=["touchstart","touchmove","touchend"],o=document.createElement("div"),c;try{for(c=0;c<b.length;c++){var d=b[c],d="on"+d,g=d in o;g||(o.setAttribute(d,"return;"),g=typeof o[d]=="function"); a[b[c]]=g}return a.touchstart&&a.touchend&&a.touchmove}catch(j){return!1}}return{createDragger:function(b){return function(f){f.pageX=f.originalEvent.changedTouches[0].pageX;f.pageY=f.originalEvent.changedTouches[0].pageY;if(a.disabled)return!1;if(b==="move"&&!a.allowMove)return!1;K=!0;E(b,O(f));f.stopPropagation();f.preventDefault();return!1}},newSelection:function(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return fa(a)},isSupported:b,support:a.touchSupport=== !0||a.touchSupport===!1?a.touchSupport:b()}}(),s=function(){function b(){if(!a.aspectRatio){var b=g-c,e=j-d;Q&&Math.abs(b)>Q&&(g=b>0?c+Q:c-Q);R&&Math.abs(e)>R&&(j=e>0?d+R:d-R);T/A&&Math.abs(e)<T/A&&(j=e>0?d+T/A:d-T/A);S/t&&Math.abs(b)<S/t&&(g=b>0?c+S/t:c-S/t);c<0&&(g-=c,c-=c);d<0&&(j-=d,d-=d);g<0&&(c-=g,g-=g);j<0&&(d-=j,j-=j);g>r&&(b=g-r,c-=b,g-=b);j>q&&(b=j-q,d-=b,j-=b);c>r&&(b=c-q,j-=b,d-=b);d>q&&(b=d-q,j-=b,d-=b);return o(f(c,d,g,j))}var b=a.aspectRatio,e=a.minSize[0]/t,k=a.maxSize[0]/t,i=g-c, m=j-d,n=Math.abs(i),l=Math.abs(m);k===0&&(k=r*10);n/l<b?(n=j,w=l*b,l=i<0?c-w:w+c,l<0?(l=0,h=Math.abs((l-c)/b),n=m<0?d-h:h+d):l>r&&(l=r,h=Math.abs((l-c)/b),n=m<0?d-h:h+d)):(l=g,h=n/b,n=m<0?d-h:d+h,n<0?(n=0,w=Math.abs((n-d)*b),l=i<0?c-w:w+c):n>q&&(n=q,w=Math.abs(n-d)*b,l=i<0?c-w:w+c));l>c?(l-c<e?l=c+e:l-c>k&&(l=c+k),n=n>d?d+(l-c)/b:d-(l-c)/b):l<c&&(c-l<e?l=c-e:c-l>k&&(l=c-k),n=n>d?d+(c-l)/b:d-(c-l)/b);l<0?(c-=l,l=0):l>r&&(c-=l-r,l=r);n<0?(d-=n,n=0):n>q&&(d-=n-q,n=q);return o(f(c,d,l,n))}function k(a){a[0]< 0&&(a[0]=0);a[1]<0&&(a[1]=0);a[0]>r&&(a[0]=r);a[1]>q&&(a[1]=q);return[a[0],a[1]]}function f(a,b,c,d){var j=a,g=c,e=b,f=d;c<a&&(j=c,g=a);d<b&&(e=d,f=b);return[Math.round(j),Math.round(e),Math.round(g),Math.round(f)]}function o(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}}var c=0,d=0,g=0,j=0,e,i;return{flipCoords:f,setPressed:function(a){a=k(a);g=c=a[0];j=d=a[1]},setCurrent:function(a){a=k(a);e=a[0]-g;i=a[1]-j;g=a[0];j=a[1]},getOffset:function(){return[e,i]},moveOffset:function(a){var b= a[0],a=a[1];0>c+b&&(b-=b+c);0>d+a&&(a-=a+d);q<j+a&&(a+=q-(j+a));r<g+b&&(b+=r-(g+b));c+=b;g+=b;d+=a;j+=a},getCorner:function(a){var c=b();switch(a){case "ne":return[c.x2,c.y];case "nw":return[c.x,c.y];case "se":return[c.x2,c.y2];case "sw":return[c.x,c.y2]}},getFixed:b}}(),m=function(){function b(b){b=e("<div />").css({position:"absolute",opacity:a.borderOpacity}).addClass(a.baseClass+"-"+b);ba.append(b);return b}function k(a,b){var c=e("<div />").mousedown(da(a)).css({cursor:a+"-resize",position:"absolute", zIndex:b});G.support&&c.bind("touchstart",G.createDragger(a));L.append(c);return c}function f(b){var c=a.handleSize,d=c,j=n,g=n;switch(b){case "n":case "s":c=B(100);break;case "e":case "w":d=B(100)}return k(b,A++).width(c).height(d).css({top:p(-j+1),left:p(-g+1)})}function o(b){var c;for(c=0;c<b.length;c++)z[b[c]]=k(b[c],A++).css({top:p(-n+1),left:p(-n+1),opacity:a.handleOpacity}).addClass(a.baseClass+"-handle")}function c(a){var b=Math.round(a.h/2-n),c=Math.round(a.w/2-n),d=a.w-n,a=a.h-n;z.e&&(z.e.css({top:p(b), left:p(d)}),z.w.css({top:p(b)}),z.s.css({top:p(a),left:p(c)}),z.n.css({left:p(c)}));z.ne&&(z.ne.css({left:p(d)}),z.se.css({top:p(a),left:p(d)}),z.sw.css({top:p(a)}));z.b&&(z.b.css({top:p(a)}),z.r.css({left:p(d)}))}function d(){var a=s.getFixed();s.setPressed([a.x,a.y]);s.setCurrent([a.x2,a.y2]);g()}function g(){if(t)return j()}function j(){var b=s.getFixed(),d=b.h;M.width(b.w).height(d);var d=b.x,j=b.y;V.css({top:p(-j),left:p(-d)});M.css({top:p(j+(ra-u.offset().top)),left:p(d+(qa-u.offset().left))}); v&&c(b);t||(M.show(),a.bgFade?i.fadeTo(a.fadeTime,U):i.css("opacity",U),t=!0);a.onChange.call(H,Z(b))}function m(){v=!0;if(a.allowResize)return c(s.getFixed()),L.show(),!0}function q(){v=!1;L.hide()}function r(a){void 0===a?q():m()}var t,A=370,z={},v=!1,n=a.handleOffset;a.drawBorders&&(b("hline"),b("hline bottom"),b("vline"),b("vline right"));if(a.dragEdges)z.t=f("n"),z.b=f("s"),z.r=f("e"),z.l=f("w");a.sideHandles&&o(["n","s","e","w"]);a.cornerHandles&&o(["sw","nw","ne","se"]);var l=ha().mousedown(da("move")).css({cursor:"move", position:"absolute",zIndex:360});G.support&&l.bind("touchstart.jcrop",G.createDragger("move"));ba.append(l);q();return{updateVisible:g,update:j,release:function(){q();M.hide();a.bgFade?i.fadeTo(a.fadeTime,1):i.css("opacity",1);t=!1;a.onRelease.call(H)},refresh:d,isAwake:function(){return t},setCursor:function(a){l.css("cursor",a)},enableHandles:m,enableOnly:function(){v=!0},showHandles:function(){v&&(c(s.getFixed()),L.show())},disableHandles:q,animMode:r,done:function(){r(!1);d()}}}(),C=function(){function b(a){c(O(a)); return!1}function k(j){j.preventDefault();j.stopPropagation();K&&(K=!1,d(O(j)),m.isAwake()&&a.onSelect.call(H,Z(s.getFixed())),F.css({zIndex:290}),g&&e(document).unbind("mousemove",b).unbind("mouseup",k),c=function(){},d=function(){});return!1}function f(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return b(a)}function o(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return k(a)}var c=function(){}, d=function(){},g=a.trackDocument;G.support&&e(document).bind("touchmove",f).bind("touchend",o);g||F.mousemove(b).mouseup(k).mouseout(k);i.before(F);return{activateHandlers:function(a,f){K=!0;c=a;d=f;F.css({zIndex:450});g&&e(document).bind("mousemove",b).bind("mouseup",k);return!1},setCursor:function(a){F.css("cursor",a)}}}(),Y=function(){function b(){o.hide()}function k(b,c,f){a.allowMove&&(s.moveOffset([c,f]),m.updateVisible());b.preventDefault();b.stopPropagation()}function f(a){if(a.ctrlKey)return!0; var b=(sa=a.shiftKey?!0:!1)?10:1;switch(a.keyCode){case 37:k(a,-b,0);break;case 39:k(a,b,0);break;case 38:k(a,0,-b);break;case 40:k(a,0,b);break;case 27:m.release();break;case 9:return!0}return!1}var o=e('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}),c=e("<div />").css({position:"absolute",overflow:"hidden"}).append(o);a.keySupport&&(o.keydown(f).blur(b),aa||!a.fixedSupport?(o.css({position:"absolute",left:"-20px"}),c.append(o).insertBefore(i)):o.insertBefore(i));return{watchKeys:function(){a.keySupport&& (o.show(),o.focus())}}}();G.support&&F.bind("touchstart",G.newSelection);L.hide();$(!0);var H={setImage:function(b,e){m.release();ka();var f=new Image;f.onload=function(){var o=f.height,c=a.boxWidth,d=a.boxHeight;i.width(f.width).height(o);i.attr("src",b);V.attr("src",b);ea(i,c,d);r=i.width();q=i.height();V.width(r).height(q);F.width(r+N*2).height(q+N*2);u.width(r).height(q);la();typeof e==="function"&&e.call(H)};f.src=b},animateTo:function(b,e){var f=parseInt(b[0],10)/t,i=parseInt(b[1],10)/A,c=parseInt(b[2], 10)/t,d=parseInt(b[3],10)/A,f=s.flipCoords(f,i,c,d),i=s.getFixed(),g=[i.x,i.y,i.x2,i.y2],j=a.animationDelay,q=f[0]-g[0],p=f[1]-g[1],r=f[2]-g[2],v=f[3]-g[3],u=0,z=a.swingSpeed;x=g[0];y=g[1];c=g[2];d=g[3];m.animMode(!0);var B=function(){return function(){u+=(100-u)/z;g[0]=x+u/100*q;g[1]=y+u/100*p;g[2]=c+u/100*r;g[3]=d+u/100*v;u>=99.8&&(u=100);u<100?(ja(g),window.setTimeout(B,j)):(m.done(),typeof e==="function"&&e.call(H))}}();window.setTimeout(B,j)},setSelect:ia,setOptions:function(a){J(a);$()},tellSelect:function(){return Z(s.getFixed())}, tellScaled:function(){return s.getFixed()},setClass:function(b){u.removeClass().addClass(a.baseClass+"-holder").addClass(b)},disable:ka,enable:la,cancel:function(){m.done();C.activateHandlers(null,null)},release:m.release,destroy:function(){D.show();e(v).removeData("Jcrop");u.empty();u.remove()},focus:Y.watchKeys,getBounds:function(){return[r*t,q*A]},getWidgetSize:function(){return[r,q]},getScaleFactor:function(){return[t,A]},ui:{holder:u,selection:M}};e.browser.msie&&u.bind("selectstart",function(){return!1}); D.data("Jcrop",H);return H};e.fn.Jcrop=function(v,I){function p(p){var B=typeof v==="object"?v:{},J=B.useImg||p.src,E=new Image;E.onload=function(){function v(){if(!E.width||!E.height)window.setTimeout(v,50);else{var J=e.Jcrop(p,B);typeof I==="function"&&I.call(J)}}window.setTimeout(v,50)};E.src=J}var B=null;this.each(function(){e(this).data("Jcrop")?v==="api"?B==null&&(B=e(this).data("Jcrop")):e(this).data("Jcrop").setOptions(v):p(this)});return B?B:this};e.Jcrop.defaults={allowSelect:!0,allowMove:!0, allowResize:!0,trackDocument:!0,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:0.6,bgFade:!1,borderOpacity:0.4,handleOpacity:0.5,handleSize:9,handleOffset:5,aspectRatio:0,keySupport:!0,cornerHandles:!0,sideHandles:!0,drawBorders:!0,dragEdges:!0,fixedSupport:!0,touchSupport:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,container:null,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onRelease:function(){}}})(jQuery);